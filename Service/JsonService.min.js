import ValidatorService from"./ValidatorService.js";export default class JsonService{constructor(){this._json=[];this._outputJson=[]}get json(){return JSON.parse(JSON.stringify(this._json))}getJsonData(){return JSON.parse(JSON.stringify(this.removeAction(this.json)))}removeAction(json){json.map((row=>row.filter((field=>!field.name.startsWith("dyjsform_action_")))));return json}set json(json){switch(typeof json){case"string":this._json=this.strToJson(json);break;default:this._json=json;break}this.outputJson=this.getJsonData()}addRow(entity){const updatedJson=this.json;updatedJson.push(entity);this.json=updatedJson;return this}removeRow(rowNumber){const updatedJson=this.json;updatedJson.splice(rowNumber,1);this.json=updatedJson;return this}get outputJson(){return this._outputJson}set outputJson(json){this._outputJson=this.reduceByNameValue(json)}isJsonString(str){try{JSON.parse(str)}catch(e){console.error(e);return false}return true}jsonToStr(jsonObject){return JSON.stringify(jsonObject,null,2)}strToJson(str){try{return JSON.parse(str)}catch(error){console.error("Erreur lors du parsing JSON :",error);return null}}reduceByNameValue(json){var ReducedJson=[];for(const row of json){let rowJson=[];for(let field of row){rowJson.push({[field["name"]]:field["value"]})}ReducedJson.push(rowJson)}return ReducedJson}loadReducedJson(outputJson){let json=this.json;while(json.length<outputJson.length){const templateRow=json[json.length-1].map((field=>({...field,value:""})));json.push(templateRow)}const updatedJson=json.map(((row,rowIndex)=>row.map(((field,fieldIndex)=>{const newField={...field};if(!newField.name.startsWith("dyjsform_action_")){const fieldKey=Object.keys(outputJson[rowIndex][fieldIndex]);const outputJsonValue=Object.keys(outputJson[rowIndex][fieldIndex]).find((key=>key===newField.name))?outputJson[rowIndex][fieldIndex][newField.name]:"";newField.value=outputJsonValue}return newField}))));this.json=updatedJson}updateJsonByField(rowIndex,fieldName,value){let json=this.json;json[rowIndex].forEach((element=>{if(element.name===fieldName){element.value=value}}));const result=this.validate(json,rowIndex);if(result.success){json=this.errorClean(json)}else{json=this.displayError(result,json,rowIndex)}this.json=json;return result}validate(json){const validationResult=ValidatorService.validateMaxCount(json);if(validationResult.valid){console.log("Validation réussie : Aucun conflit détecté.");return{success:true,errors:null}}else{console.log("Validation échouée :",validationResult);return{success:false,errors:validationResult.errors}}}displayError(validationResult,json,rowIndex=null){if(rowIndex!==null){validationResult.errors.forEach((errorGroup=>{const error=errorGroup.occurrences.find((err=>err.rowIndex===rowIndex));if(error){const entity=json[rowIndex].find((entity=>entity.name===error.name));if(entity){entity.error=errorGroup.message;entity.value=""}}}))}else{validationResult.errors.forEach((errorGroup=>{errorGroup.occurrences.forEach((error=>{const entity=json[error.rowIndex].find((ent=>ent.name===error.name));if(entity){entity.error=errorGroup.message}}))}))}return json}errorClean(json){json=json.map((row=>row.map((entity=>({...entity,error:""})))));return json}}