export default class Dyjsform{constructor(templateName="classic"){this.entity=[{html_element:"input",type:"number",name:"name_1",label:"name_1",value:"",content:"",class:""},{html_element:"input",type:"text",label:"name_1",name:"name_2",value:"",content:"",class:""},{html_element:"input",type:"password",label:"name_1",name:"name_3",value:"",content:"",class:""}];this.json=[];this.templateName=templateName;this.template=null}async init(){console.log("initializing Dyjsform");this.loadTemplate().then((()=>{this.initForm();this.initHandlers()}));return this}getEntity(){return this.entity}setEntity(array){this.entity=array;return this}getJson(){return this.json}setJson(json){switch(typeof json){case"string":this.json=this.strToJson(json);break;default:this.json=json;break}return this}isJsonString(str){try{JSON.parse(str)}catch(e){console.log(e);return false}return true}jsonToStr(jsonObject){return JSON.stringify(jsonObject,null,2)}strToJson(str){try{return JSON.parse(str)}catch(error){console.error("Erreur lors du parsing JSON :",error);return null}}async loadTemplate(){const templateIndex=await import("./template");this.template=new templateIndex[this.templateName]}async refreshForm(json=null){console.log("refreshing Dyjsform");this.initForm();await this.rowsUpdate();this.initHandlers();this.generateJson();console.log(this.getJson());return this}getTemplate(){return this.template}async setTemplate(templateName){this.templateName=templateName.charAt(0).toUpperCase()+templateName.slice(1);return this}initForm(){let json=this.json;const template=this.template;document.querySelector("#dyjsform").innerHTML=template.getForm(json);return this}initHandlers(){this.initEventListeners();this.handleInputKeyup()}async initEventListeners(){if(document.getElementById("djf_action_add")){document.getElementById("djf_action_add").addEventListener("click",(event=>{console.log("djf_action_add");event.preventDefault();let json=this.getJson();json.push(this.entity);this.setJson(json);this.generateJson();this.refreshForm()}))}if(document.getElementById("djf_action_remove")){console.log("document.getElementById(djf_action_remove)");document.getElementById("djf_action_remove").addEventListener("click",(event=>{console.log("djf_action_remove");event.preventDefault();let json=this.getJson();json.pop();this.setJson(json);this.generateJson();this.refreshForm()}))}return this}async handleInputKeyup(){for(const entity of this.entity){const elements=document.querySelectorAll("."+entity.name);if(elements.length>0){elements.forEach((element=>{element.addEventListener("keyup",(async()=>{await this.refreshForm()}));element.addEventListener("change",(async()=>{await this.refreshForm()}))}))}}return this}generateJson(){console.log("generateJson");let result="";let data=[];if(document.querySelectorAll("#dyjsform_container .dyjsform_entity").length){console.log("if");console.log("document.querySelectorAll('#dyjsform_container .dyjsform_entity')");console.log(document.querySelectorAll("#dyjsform_container .dyjsform_entity"));document.querySelectorAll("#dyjsform_container .dyjsform_entity").forEach((dyjsformEntity=>{console.log("foreach");let entityData={};for(let entity of this.entity){entityData[entity.name]=dyjsformEntity.querySelector("."+entity.name).value}console.log("entityData");console.log(entityData);data.push(entityData)}))}document.querySelector("#dyjsform_options").value=JSON.stringify(data,null);return result}async rowsUpdate(){const template=this.template;let begin=`<div class="row form-group align-items-center dyjsform_entity">`;let end=`</div>`;let rows=this.getJson();let HtmlForm=begin;for(let row of rows){HtmlForm+=await this.generateFields(row)}HtmlForm+=end;this.addEntityToHtml(HtmlForm)}async generateFields(json){const fieldNumber=this.getEntity().length;const BSColumnWidth=(12/fieldNumber).toFixed(0);const template=this.template;let Html="";for(let field of json){Html+=template.getField(field,BSColumnWidth)}return Html}addEntityToHtml(HtmlForm){document.querySelector("#dyjsform_container").innerHTML+=HtmlForm;this.handleInputKeyup()}loadJson(){let entitiesArray=[];let entityArray=[];if(document.querySelector("#dyjsform_options")){const jsonString=document.querySelector("#dyjsform_options").value;if(jsonString){try{const jsonString=document.querySelector("#dyjsform_options").value;console.log(jsonString)}catch(error){console.error("Erreur lors de l'analyse du JSON : ",error)}}}this.setJson(JSON.stringify(entityArray,null));return this}}