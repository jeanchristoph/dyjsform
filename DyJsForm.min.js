import JsonService from"./Service/JsonService.js";import TemplateService from"./Service/TemplateService.js";import DebugService from"./Service/DebugService.js";import EntityDTO from"./DTO/EntityDTO.js";import OptionDTO from"./DTO/OptionDTO.js";export default class DyJsForm{constructor(selector="",{debug:debug=false}){this._entity=[];this._jsonService=new JsonService;this._templateService=new TemplateService;this._onDataEditTimeOut=null;this._selector=selector;if(debug){return new DebugService(this)}return this}get entity(){return JSON.parse(JSON.stringify(this._entity))}getEntityData(){return JSON.parse(JSON.stringify(this._entity.filter((item=>!item.name.startsWith("dyjsform_action_")))))}set entity(array){this._entity=array.map((data=>{const options=(data.options||[]).map((opt=>new OptionDTO({name:opt.name||"",value:opt.value||"",maxCount:opt.maxCount||null})));return new EntityDTO({htmlElement:data.htmlElement||"",type:data.type||"",name:data.name||"",label:data.label||"",value:data.value||"",content:data.content||"",className:data.className||"",options:options})}));return this}get selector(){return this._selector}set selector(value){this._selector=value}init(){this._templateService.loadTemplate().then((()=>{const form=this._templateService.formRender();document.querySelector(this._selector).innerHTML=form;this.initHandlers()}));return this}refreshForm(){const form=this._templateService.formRender();document.querySelector("#dyjsform").innerHTML=form;const row=this._templateService.rowRender(this.entity,this._jsonService.json);document.querySelector("#dyjsform_container").innerHTML=row;this.writeOutputJson();this.initHandlers();return this}initHandlers(){this.initEventListeners();this.handleInputKeyup()}initEventListeners(){this.addHandler();this.deleteHandler();return this}addHandler(){document.querySelectorAll(".dyjsform_action_add").forEach((element=>{element.addEventListener("click",(event=>{event.preventDefault();this._jsonService.addRow(this.entity);this.refreshForm()}))}))}deleteHandler(){document.querySelectorAll(".dyjsform_action_remove").forEach((element=>{element.addEventListener("click",(event=>{const rowNumber=event.target.getAttribute("data-row");event.preventDefault();this._jsonService.removeRow(rowNumber);this.refreshForm()}))}))}onDataEdit(element){console.log(element);let rowNumber=element.getAttribute("data-row");let fieldName=element.getAttribute("data-name");let value=element.value;try{this._jsonService.updateJsonByField(rowNumber,fieldName,value)}catch(e){console.log(e);console.error("ERREUR :",e[0].message);this.refreshForm()}this.writeOutputJson()}async handleInputKeyup(){for(const entity of this.getEntityData()){const elements=document.querySelectorAll("."+entity.name);if(elements.length>0){elements.forEach((element=>{element.addEventListener("keyup",(event=>{this.onDataEdit(event.target)}));element.addEventListener("change",(event=>{this.onDataEdit(event.target)}))}))}}return this}writeOutputJson(){document.querySelector("#dyjsform_options").value=JSON.stringify(this._jsonService.outputJson,null);return this}}