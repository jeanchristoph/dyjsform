import JsonService from"./Service/JsonService.js";import TemplateService from"./Service/TemplateService.js";import DebugService from"./Service/DebugService.js";export default class DyJsForm{constructor(debug=0){this._entity=[{html_element:"input",type:"number",name:"name_1",label:"name_1",value:"",content:"",class:""},{html_element:"input",type:"text",label:"name_1",name:"name_2",value:"",content:"",class:""},{html_element:"input",type:"password",label:"name_1",name:"name_3",value:"",content:"",class:""}];this._jsonService=new JsonService;this._templateService=new TemplateService;this._onDataEditTimeOut=null;if(debug===1){return new DebugService(this)}return this}get entity(){return JSON.parse(JSON.stringify(this._entity))}getEntityData(){return JSON.parse(JSON.stringify(this._entity.filter((item=>!item.name.startsWith("dyjsform_action_")))))}set entity(array){this._entity=array;return this}get template(){return this._templateService.templateName}set template(templateName){this._templateService.templateName=templateName.charAt(0).toUpperCase()+templateName.slice(1);return this}init(){this._templateService.loadTemplate().then((()=>{const form=this._templateService.formRender();document.querySelector("#dyjsform").innerHTML=form;this.initHandlers()}));return this}refreshForm(){const form=this._templateService.formRender();document.querySelector("#dyjsform").innerHTML=form;const row=this._templateService.rowRender(this.entity,this._jsonService.json);document.querySelector("#dyjsform_container").innerHTML=row;this.writeOutputJson();this.initHandlers();return this}initHandlers(){this.initEventListeners();this.handleInputKeyup()}initEventListeners(){this.addHandler();this.deleteHandler();return this}addHandler(){document.querySelectorAll(".dyjsform_action_add").forEach((element=>{element.addEventListener("click",(event=>{event.preventDefault();this._jsonService.addRow(this.entity);this.refreshForm()}))}))}deleteHandler(){document.querySelectorAll(".dyjsform_action_remove").forEach((element=>{element.addEventListener("click",(event=>{const rowNumber=event.target.getAttribute("data-row");event.preventDefault();this._jsonService.removeRow(rowNumber);this.refreshForm()}))}))}onDataEdit(element){if(this._onDataEditTimeOut){clearTimeout(this._onDataEditTimeOut)}this._onDataEditTimeOut=setTimeout((()=>{let rowNumber=element.getAttribute("data-row");let fieldName=element.getAttribute("data-name");let value=element.value;this._jsonService.updateJsonByField(rowNumber,fieldName,value);this.writeOutputJson()}),1e3)}async handleInputKeyup(){for(const entity of this.getEntityData()){const elements=document.querySelectorAll("."+entity.name);if(elements.length>0){elements.forEach((element=>{element.addEventListener("keyup",(event=>{this.onDataEdit(event.target)}));element.addEventListener("change",(event=>{this.onDataEdit(event.target)}))}))}}return this}writeOutputJson(){document.querySelector("#dyjsform_options").value=JSON.stringify(this._jsonService.outputJson,null);return this}}